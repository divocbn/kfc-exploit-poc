"use client"

import { forwardRef } from "react"
import { cn } from "~/lib/utils"

import { DialogProps } from "@radix-ui/react-dialog"
import { useAtomValue } from "jotai"
import { DeleteIcon, ShoppingCartIcon, TrashIcon } from "lucide-react"
import { Button } from "../ui/button"
import { Sheet, SheetContent, SheetDescription, SheetHeader, SheetTitle, SheetTrigger } from "../ui/sheet"

import { shoppingCartAtom } from "~/atoms/cart.atom"
import { Badge } from "../ui/badge"
import { toast } from "sonner"

export interface ShoppingCartProps
  extends React.HTMLAttributes<DialogProps> { }

const ShoppingCart = forwardRef<DialogProps, ShoppingCartProps>(
  ({ className, ...props }, ref) => {
    const cart = useAtomValue(shoppingCartAtom);

    return (
      <Sheet {...props}>
        <SheetTrigger asChild>
          <Button size="sm" className="relative">
            {cart.length > 0 &&
              <Badge className="absolute -top-2 -left-2 px-2">{cart.length}</Badge>
            }

            <ShoppingCartIcon className="w-4" />
          </Button>
        </SheetTrigger>
        <SheetContent>
          <SheetHeader>
            <SheetTitle>Warenkorb</SheetTitle>
            <SheetDescription>
              { /* nah that code looks dead af, hey its just a poc */}
              <div className="flex flex-col justify-between h-[90vh]">
                <div className="flex w-full flex-col">
                  {cart.map((item, index) =>
                    <div className="flex justify-between gap-2 py-2 border-b w-full">
                      <Button
                        key={index}
                        className="justify-start w-full max-w-64 gap-2">
                        <span className="max-w-full text-ellipsis overflow-hidden">
                          {item.name}
                        </span>
                        <span className="text-black/50 text-xs font-normal">
                          {item.price.toLocaleString("de-DE")}€
                        </span>
                      </Button>

                      <Button>
                        <TrashIcon className="w-4" />
                      </Button>
                    </div>
                  )}
                </div>

                <div className="flex flex-col gap-2">
                  <p>Preis: { cart.reduce((total, item) => item.price + total, 0).toLocaleString("de-DE")}€ </p>
                  <Button 
                    variant={"destructive"} 
                    onClick={() => toast("Noch nicht implementiert.")}>Bezahlen (oder auch nicht)</Button>
                </div>
              </div>
            </SheetDescription>
          </SheetHeader>
        </SheetContent>
      </Sheet>
    )
  }
)
ShoppingCart.displayName = "ShoppingCart"

export { ShoppingCart }
